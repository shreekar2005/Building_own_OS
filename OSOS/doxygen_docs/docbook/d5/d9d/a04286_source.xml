<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="_a04286_source" xml:lang="en-US">
<title>kmouse.cpp</title>
<indexterm><primary>libk_src/driver/kmouse.cpp</primary></indexterm>
Go to the documentation of this file.<programlisting linenumbering="unnumbered"><anchor xml:id="_a04286_source_1l00001"/>00001 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_a04358">driver/kmouse.hpp</link>&quot;</emphasis>
<anchor xml:id="_a04286_source_1l00002"/>00002 
<anchor xml:id="_a04286_source_1l00003"/>00003 <emphasis role="comment">//&#32;---&#32;MouseEventHandler&#32;---</emphasis>
<anchor xml:id="_a04286_source_1l00004"/>00004 
<anchor xml:id="_a04286_source_1l00005"/><link linkend="_a05265_1aa0fd3739c52bcd4d553cefaf41760a9b">00005</link> <link linkend="_a05265_1aa0fd3739c52bcd4d553cefaf41760a9b">driver::MouseEventHandler::MouseEventHandler</link>(){}
<anchor xml:id="_a04286_source_1l00006"/><link linkend="_a05265_1abbfe4a7ae2911f989513178530314211">00006</link> <link linkend="_a05265_1abbfe4a7ae2911f989513178530314211">driver::MouseEventHandler::~MouseEventHandler</link>(){}
<anchor xml:id="_a04286_source_1l00007"/>00007 
<anchor xml:id="_a04286_source_1l00008"/>00008 
<anchor xml:id="_a04286_source_1l00009"/>00009 <emphasis role="comment">//&#32;---&#32;MouseDriver&#32;---</emphasis>
<anchor xml:id="_a04286_source_1l00010"/>00010 
<anchor xml:id="_a04286_source_1l00011"/>00011 <emphasis role="comment">//&#32;Static&#32;member&#32;initialization</emphasis>
<anchor xml:id="_a04286_source_1l00012"/>00012 uint16_t&#32;<link linkend="_a05269_1a4a671e7e2b235f6bec473cb960401bd6">driver::MouseDriver::old_char_under_mouse_pointer</link>;
<anchor xml:id="_a04286_source_1l00013"/>00013 <emphasis role="comment">//&#32;DO&#32;NOT&#32;CHANGE&#32;THESE&#32;-1&#32;INITIALIZATIONS&#32;(THAT&#32;WILL&#32;LEAD&#32;TO&#32;BUG&#32;OF&#32;&quot;GHOST&#32;MOUSE&#32;POINTER&quot;)</emphasis>
<anchor xml:id="_a04286_source_1l00014"/>00014 int8_t&#32;<link linkend="_a05269_1ac2077f6309c79d5f585fb966b57fe065">driver::MouseDriver::__mouse_x_</link>&#32;=&#32;-1;
<anchor xml:id="_a04286_source_1l00015"/>00015 int8_t&#32;<link linkend="_a05269_1aa02009b37420687ef18db8a05ff9181f">driver::MouseDriver::__mouse_y_</link>&#32;=&#32;-1;
<anchor xml:id="_a04286_source_1l00016"/>00016 
<anchor xml:id="_a04286_source_1l00017"/><link linkend="_a05269_1a1a2a455ca7146dea3148afa8cb6c9ed5">00017</link> uint16_t&#32;<link linkend="_a05269_1a1a2a455ca7146dea3148afa8cb6c9ed5">driver::MouseDriver::mouse_block_video_mem_value</link>(uint16_t&#32;current_char,&#32;uint8_t&#32;mouse_pointer_color){
<anchor xml:id="_a04286_source_1l00018"/>00018 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;(current_char&#32;&amp;&#32;0x0FFF)&#32;|&#32;(mouse_pointer_color&#32;&lt;&lt;&#32;12);
<anchor xml:id="_a04286_source_1l00019"/>00019 }
<anchor xml:id="_a04286_source_1l00020"/>00020 
<anchor xml:id="_a04286_source_1l00021"/>00021 <emphasis role="comment">//&#32;Constructor:&#32;Initialize&#32;with&#32;an&#32;event&#32;handler</emphasis>
<anchor xml:id="_a04286_source_1l00022"/><link linkend="_a05269_1a639956c8ce11d62ee443825e9b9695af">00022</link> <link linkend="_a05269_1a639956c8ce11d62ee443825e9b9695af">driver::MouseDriver::MouseDriver</link>(<link linkend="_a05293">hardware_communication::InterruptManager</link>*&#32;interrupt_manager,&#32;<link linkend="_a05265">driver::MouseEventHandler</link>*&#32;mouseEventHandler)
<anchor xml:id="_a04286_source_1l00023"/>00023 :&#32;<link linkend="_a04377">hardware_communication</link>::InterruptHandler(0x2C,&#32;interrupt_manager),&#32;
<anchor xml:id="_a04286_source_1l00024"/>00024 &#32;&#32;dataPort(0x60),&#32;
<anchor xml:id="_a04286_source_1l00025"/>00025 &#32;&#32;commandPort(0x64)
<anchor xml:id="_a04286_source_1l00026"/>00026 {
<anchor xml:id="_a04286_source_1l00027"/>00027 &#32;&#32;&#32;&#32;this-&gt;mouseEventHandler&#32;=&#32;<link linkend="_a05269_1a804f5657a062e0a18f3b56781f884c66">mouseEventHandler</link>;
<anchor xml:id="_a04286_source_1l00028"/>00028 }
<anchor xml:id="_a04286_source_1l00029"/>00029 
<anchor xml:id="_a04286_source_1l00030"/><link linkend="_a05269_1a8c25e4a4b42d1d39b332ba6d4cbd6a22">00030</link> <link linkend="_a05269_1a8c25e4a4b42d1d39b332ba6d4cbd6a22">driver::MouseDriver::~MouseDriver</link>(){}
<anchor xml:id="_a04286_source_1l00031"/>00031 
<anchor xml:id="_a04286_source_1l00032"/><link linkend="_a05269_1a1b2f08490b7954e5ca504cd8bb6862c0">00032</link> uint32_t&#32;<link linkend="_a05269_1a1b2f08490b7954e5ca504cd8bb6862c0">driver::MouseDriver::handleInterrupt</link>(uint32_t&#32;esp){
<anchor xml:id="_a04286_source_1l00033"/>00033 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Check&#32;if&#32;the&#32;mouse&#32;has&#32;sent&#32;data</emphasis>
<anchor xml:id="_a04286_source_1l00034"/>00034 &#32;&#32;&#32;&#32;uint8_t&#32;status&#32;=&#32;commandPort.read();
<anchor xml:id="_a04286_source_1l00035"/>00035 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>(!(status&#32;&amp;&#32;0x20))&#32;<emphasis role="keywordflow">return</emphasis>&#32;esp;
<anchor xml:id="_a04286_source_1l00036"/>00036 &#32;&#32;&#32;&#32;
<anchor xml:id="_a04286_source_1l00037"/>00037 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Read&#32;the&#32;next&#32;byte&#32;of&#32;the&#32;packet</emphasis>
<anchor xml:id="_a04286_source_1l00038"/>00038 &#32;&#32;&#32;&#32;buffer[offset]&#32;=&#32;dataPort.read();
<anchor xml:id="_a04286_source_1l00039"/>00039 &#32;&#32;&#32;&#32;offset&#32;=&#32;(offset&#32;+&#32;1)&#32;%&#32;3;
<anchor xml:id="_a04286_source_1l00040"/>00040 
<anchor xml:id="_a04286_source_1l00041"/>00041 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;When&#32;a&#32;full&#32;3-byte&#32;packet&#32;is&#32;received</emphasis>
<anchor xml:id="_a04286_source_1l00042"/>00042 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>(offset&#32;==&#32;0){
<anchor xml:id="_a04286_source_1l00043"/>00043 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>(mouseEventHandler&#32;==&#32;0)&#32;<emphasis role="keywordflow">return</emphasis>&#32;esp;&#32;<emphasis role="comment">//&#32;Do&#32;nothing&#32;without&#32;a&#32;handler</emphasis>
<anchor xml:id="_a04286_source_1l00044"/>00044 
<anchor xml:id="_a04286_source_1l00045"/>00045 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;---&#32;Handle&#32;Mouse&#32;Movement&#32;---</emphasis>
<anchor xml:id="_a04286_source_1l00046"/>00046 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;int8_t&#32;delta_x&#32;=&#32;buffer[1];
<anchor xml:id="_a04286_source_1l00047"/>00047 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;int8_t&#32;delta_y&#32;=&#32;-buffer[2];&#32;<emphasis role="comment">//&#32;Y-axis&#32;is&#32;inverted&#32;from&#32;the&#32;mouse&apos;s&#32;perspective</emphasis>
<anchor xml:id="_a04286_source_1l00048"/>00048 
<anchor xml:id="_a04286_source_1l00049"/>00049 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;(delta_x&#32;!=&#32;0&#32;||&#32;delta_y&#32;!=&#32;0)&#32;{
<anchor xml:id="_a04286_source_1l00050"/>00050 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;mouseEventHandler-&gt;<link linkend="_a05265_1a68f635b3b65f927d37d4e0835f7e0b30">onMouseMove</link>(delta_x,&#32;delta_y);
<anchor xml:id="_a04286_source_1l00051"/>00051 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_a04286_source_1l00052"/>00052 
<anchor xml:id="_a04286_source_1l00053"/>00053 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;---&#32;Handle&#32;Mouse&#32;Buttons&#32;---</emphasis>
<anchor xml:id="_a04286_source_1l00054"/>00054 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">for</emphasis>(uint8_t&#32;i&#32;=&#32;0;&#32;i&#32;&lt;&#32;3;&#32;i++)&#32;{
<anchor xml:id="_a04286_source_1l00055"/>00055 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Check&#32;if&#32;the&#32;state&#32;of&#32;button&#32;&apos;i&apos;&#32;has&#32;changed</emphasis>
<anchor xml:id="_a04286_source_1l00056"/>00056 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>((buffer[0]&#32;&amp;&#32;(1&#32;&lt;&lt;&#32;i))&#32;!=&#32;(buttons&#32;&amp;&#32;(1&#32;&lt;&lt;&#32;i)))&#32;{
<anchor xml:id="_a04286_source_1l00057"/>00057 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>(buffer[0]&#32;&amp;&#32;(1&#32;&lt;&lt;&#32;i))&#32;{
<anchor xml:id="_a04286_source_1l00058"/>00058 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;mouseEventHandler-&gt;onMouseDown(i&#32;+&#32;1);&#32;<emphasis role="comment">//&#32;Left=1,&#32;Right=2,&#32;Middle=3</emphasis>
<anchor xml:id="_a04286_source_1l00059"/>00059 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}&#32;<emphasis role="keywordflow">else</emphasis>&#32;{
<anchor xml:id="_a04286_source_1l00060"/>00060 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;mouseEventHandler-&gt;onMouseUp(i&#32;+&#32;1);
<anchor xml:id="_a04286_source_1l00061"/>00061 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_a04286_source_1l00062"/>00062 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_a04286_source_1l00063"/>00063 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_a04286_source_1l00064"/>00064 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;buttons&#32;=&#32;buffer[0];&#32;<emphasis role="comment">//&#32;Save&#32;the&#32;current&#32;button&#32;state&#32;for&#32;the&#32;next&#32;interrupt</emphasis>
<anchor xml:id="_a04286_source_1l00065"/>00065 &#32;&#32;&#32;&#32;}
<anchor xml:id="_a04286_source_1l00066"/>00066 
<anchor xml:id="_a04286_source_1l00067"/>00067 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">return</emphasis>&#32;esp;
<anchor xml:id="_a04286_source_1l00068"/>00068 }
<anchor xml:id="_a04286_source_1l00069"/>00069 
<anchor xml:id="_a04286_source_1l00070"/>00070 
<anchor xml:id="_a04286_source_1l00071"/>00071 
<anchor xml:id="_a04286_source_1l00072"/>00072 <emphasis role="comment">//------------------------------OVERRIDING&#32;VIRTUAL&#32;FUNCTIONS&#32;FROM&#32;DRIVER&#32;INTERFACE-----------------------------</emphasis>
<anchor xml:id="_a04286_source_1l00073"/>00073 
<anchor xml:id="_a04286_source_1l00074"/><link linkend="_a05269_1a446769df0b3b537a525476c7c8be47bc">00074</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_a05269_1a446769df0b3b537a525476c7c8be47bc">driver::MouseDriver::activate</link>(){
<anchor xml:id="_a04286_source_1l00075"/>00075 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">while</emphasis>(commandPort.read()&#32;&amp;&#32;1)&#32;dataPort.read();
<anchor xml:id="_a04286_source_1l00076"/>00076 &#32;&#32;&#32;&#32;offset&#32;=&#32;0;
<anchor xml:id="_a04286_source_1l00077"/>00077 &#32;&#32;&#32;&#32;buttons&#32;=&#32;0;
<anchor xml:id="_a04286_source_1l00078"/>00078 &#32;&#32;&#32;&#32;__mouse_x_&#32;=&#32;40;
<anchor xml:id="_a04286_source_1l00079"/>00079 &#32;&#32;&#32;&#32;__mouse_y_&#32;=&#32;12;
<anchor xml:id="_a04286_source_1l00080"/>00080 
<anchor xml:id="_a04286_source_1l00081"/>00081 &#32;&#32;&#32;&#32;<emphasis role="keyword">static</emphasis>&#32;uint16_t*&#32;video_memory&#32;=&#32;(uint16_t*)&#32;0xb8000;
<anchor xml:id="_a04286_source_1l00082"/>00082 &#32;&#32;&#32;&#32;old_char_under_mouse_pointer&#32;=&#32;video_memory[80&#32;*&#32;__mouse_y_&#32;+&#32;__mouse_x_];
<anchor xml:id="_a04286_source_1l00083"/>00083 &#32;&#32;&#32;&#32;video_memory[80&#32;*&#32;__mouse_y_&#32;+&#32;__mouse_x_]&#32;=&#32;mouse_block_video_mem_value(old_char_under_mouse_pointer,&#32;<link linkend="_a04358_1a637dd833f5f7af42afa1f42349a4d89e">MOUSE_POINTER_COLOR</link>);
<anchor xml:id="_a04286_source_1l00084"/>00084 
<anchor xml:id="_a04286_source_1l00085"/>00085 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Enable&#32;the&#32;auxiliary&#32;mouse&#32;device</emphasis>
<anchor xml:id="_a04286_source_1l00086"/>00086 &#32;&#32;&#32;&#32;commandPort.write(0xA8);&#32;
<anchor xml:id="_a04286_source_1l00087"/>00087 &#32;&#32;&#32;&#32;
<anchor xml:id="_a04286_source_1l00088"/>00088 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Enable&#32;the&#32;interrupts&#32;for&#32;the&#32;mouse</emphasis>
<anchor xml:id="_a04286_source_1l00089"/>00089 &#32;&#32;&#32;&#32;commandPort.write(0x20);&#32;
<anchor xml:id="_a04286_source_1l00090"/>00090 &#32;&#32;&#32;&#32;uint8_t&#32;status&#32;=&#32;(dataPort.read()&#32;|&#32;2);&#32;
<anchor xml:id="_a04286_source_1l00091"/>00091 &#32;&#32;&#32;&#32;commandPort.write(0x60);
<anchor xml:id="_a04286_source_1l00092"/>00092 &#32;&#32;&#32;&#32;dataPort.write(status);
<anchor xml:id="_a04286_source_1l00093"/>00093 
<anchor xml:id="_a04286_source_1l00094"/>00094 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Set&#32;mouse&#32;to&#32;use&#32;default&#32;settings&#32;and&#32;enable&#32;packet&#32;streaming</emphasis>
<anchor xml:id="_a04286_source_1l00095"/>00095 &#32;&#32;&#32;&#32;commandPort.write(0xD4);
<anchor xml:id="_a04286_source_1l00096"/>00096 &#32;&#32;&#32;&#32;dataPort.write(0xF4);
<anchor xml:id="_a04286_source_1l00097"/>00097 &#32;&#32;&#32;&#32;dataPort.read();&#32;<emphasis role="comment">//&#32;Acknowledge</emphasis>
<anchor xml:id="_a04286_source_1l00098"/>00098 &#32;&#32;&#32;&#32;
<anchor xml:id="_a04286_source_1l00099"/>00099 &#32;&#32;&#32;&#32;<link linkend="_a04374_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;Mouse&#32;Driver&#32;activated!\n&quot;</emphasis>);
<anchor xml:id="_a04286_source_1l00100"/>00100 }
<anchor xml:id="_a04286_source_1l00101"/>00101 
<anchor xml:id="_a04286_source_1l00102"/><link linkend="_a05269_1aabe3740996bf70fda96f0a25228954a6">00102</link> <emphasis role="keywordtype">int</emphasis>&#32;<link linkend="_a05269_1aabe3740996bf70fda96f0a25228954a6">driver::MouseDriver::reset</link>(){<emphasis role="keywordflow">return</emphasis>&#32;0;}
<anchor xml:id="_a04286_source_1l00103"/><link linkend="_a05269_1a4329c1cdedc72adf0b95cb3911c4acf6">00103</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_a05269_1a4329c1cdedc72adf0b95cb3911c4acf6">driver::MouseDriver::deactivate</link>(){}
</programlisting></section>
