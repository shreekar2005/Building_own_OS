<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<section xmlns="http://docbook.org/ns/docbook" version="5.0" xmlns:xlink="http://www.w3.org/1999/xlink" xml:id="_a11318_source" xml:lang="en-US">
<title>kgdt.cpp</title>
<indexterm><primary>libk_src/essential/kgdt.cpp</primary></indexterm>
Go to the documentation of this file.<programlisting linenumbering="unnumbered"><anchor xml:id="_a11318_source_1l00001"/>00001 <emphasis role="preprocessor">#include&#32;&quot;<link linkend="_a11396">essential/kgdt.hpp</link>&quot;</emphasis>
<anchor xml:id="_a11318_source_1l00002"/>00002 
<anchor xml:id="_a11318_source_1l00003"/>00003 <emphasis role="comment">//&#32;GDT_row&#32;(Segment&#32;Descriptor)</emphasis>
<anchor xml:id="_a11318_source_1l00004"/>00004 
<anchor xml:id="_a11318_source_1l00005"/>00005 <emphasis role="comment">//&#32;Default&#32;constructor&#32;for&#32;a&#32;null&#32;GDT_row&#32;entry.</emphasis>
<anchor xml:id="_a11318_source_1l00006"/><link linkend="_a12302_1a27ff8d9a6bf6c2c98cf78a0257e4667e">00006</link> <link linkend="_a12302_1a27ff8d9a6bf6c2c98cf78a0257e4667e">essential::GDT_row::GDT_row</link>()&#32;:&#32;<link linkend="_a11396_1aa7ae5b5a918e00776ff07fb1c58a348d">limit_low</link>(0),&#32;<link linkend="_a11396_1a71e21ea67de59991e9a27666a1752a8f">base_low</link>(0),&#32;<link linkend="_a11396_1a6b67e86f6de9204d76adab79069aec29">base_middle</link>(0),&#32;<link linkend="_a11396_1a8b0d6200bc639dd37ff68847a0adde5f">access</link>(0),&#32;<link linkend="_a11396_1acfea365f69e71368a2db03333d4afd6f">granularity</link>(0),&#32;<link linkend="_a11396_1a1a173457c7aa39c59c008fcc3332d2b3">base_high</link>(0)&#32;{}
<anchor xml:id="_a11318_source_1l00007"/>00007 
<anchor xml:id="_a11318_source_1l00008"/><link linkend="_a12302_1a5692f86b7ebf4eefdeb78e48f281092b">00008</link> <link linkend="_a12302_1a27ff8d9a6bf6c2c98cf78a0257e4667e">essential::GDT_row::GDT_row</link>(uint32_t&#32;<link linkend="_a11396_1ad516e6ff5b7dd7f6ce2946c527ddb8b9">base</link>,&#32;uint32_t&#32;<link linkend="_a11396_1ab28e82ae69032cb4ad3ec3a0be3d7129">limit</link>,&#32;uint8_t&#32;access_byte,&#32;uint8_t&#32;gran_byte)&#32;{
<anchor xml:id="_a11318_source_1l00009"/>00009 &#32;&#32;&#32;&#32;this-&gt;<link linkend="_a11396_1aa7ae5b5a918e00776ff07fb1c58a348d">limit_low</link>&#32;&#32;&#32;=&#32;(limit&#32;&amp;&#32;0xFFFF);
<anchor xml:id="_a11318_source_1l00010"/>00010 &#32;&#32;&#32;&#32;this-&gt;<link linkend="_a11396_1a71e21ea67de59991e9a27666a1752a8f">base_low</link>&#32;&#32;&#32;&#32;=&#32;(base&#32;&amp;&#32;0xFFFF);
<anchor xml:id="_a11318_source_1l00011"/>00011 &#32;&#32;&#32;&#32;this-&gt;<link linkend="_a11396_1a6b67e86f6de9204d76adab79069aec29">base_middle</link>&#32;=&#32;(base&#32;&gt;&gt;&#32;16)&#32;&amp;&#32;0xFF;
<anchor xml:id="_a11318_source_1l00012"/>00012 &#32;&#32;&#32;&#32;this-&gt;<link linkend="_a11396_1a1a173457c7aa39c59c008fcc3332d2b3">base_high</link>&#32;&#32;&#32;=&#32;(base&#32;&gt;&gt;&#32;24)&#32;&amp;&#32;0xFF;
<anchor xml:id="_a11318_source_1l00013"/>00013 
<anchor xml:id="_a11318_source_1l00014"/>00014 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;upper&#32;4&#32;bits&#32;of&#32;the&#32;20-bit&#32;limit&#32;go&#32;into&#32;the&#32;lower&#32;4&#32;bits&#32;of&#32;the&#32;granularity&#32;byte.</emphasis>
<anchor xml:id="_a11318_source_1l00015"/>00015 &#32;&#32;&#32;&#32;this-&gt;<link linkend="_a11396_1acfea365f69e71368a2db03333d4afd6f">granularity</link>&#32;=&#32;((limit&#32;&gt;&gt;&#32;16)&#32;&amp;&#32;0x0F);
<anchor xml:id="_a11318_source_1l00016"/>00016 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;granularity&#32;flags&#32;(G,&#32;D/B,&#32;L,&#32;AVL)&#32;go&#32;into&#32;the&#32;upper&#32;4&#32;bits.</emphasis>
<anchor xml:id="_a11318_source_1l00017"/>00017 &#32;&#32;&#32;&#32;this-&gt;<link linkend="_a11396_1acfea365f69e71368a2db03333d4afd6f">granularity</link>&#32;|=&#32;(gran_byte&#32;&amp;&#32;0xF0);
<anchor xml:id="_a11318_source_1l00018"/>00018 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Set&#32;the&#32;access&#32;flags&#32;for&#32;this&#32;segment.</emphasis>
<anchor xml:id="_a11318_source_1l00019"/>00019 &#32;&#32;&#32;&#32;this-&gt;<link linkend="_a11396_1a8b0d6200bc639dd37ff68847a0adde5f">access</link>&#32;=&#32;access_byte;
<anchor xml:id="_a11318_source_1l00020"/>00020 }
<anchor xml:id="_a11318_source_1l00021"/>00021 
<anchor xml:id="_a11318_source_1l00022"/><link linkend="_a12302_1a6eb69c55c0bd16040b2d766dd068df31">00022</link> <link linkend="_a12302_1a6eb69c55c0bd16040b2d766dd068df31">essential::GDT_row::~GDT_row</link>()&#32;{}
<anchor xml:id="_a11318_source_1l00023"/>00023 
<anchor xml:id="_a11318_source_1l00024"/>00024 
<anchor xml:id="_a11318_source_1l00025"/>00025 <emphasis role="comment">//&#32;GDT&#32;(Global&#32;Descriptor&#32;Table)</emphasis>
<anchor xml:id="_a11318_source_1l00026"/><link linkend="_a12306_1aa061ecab5a20a3556413fbbde4fe89d7">00026</link> <link linkend="_a12306_1aa061ecab5a20a3556413fbbde4fe89d7">essential::GDT::GDT</link>()
<anchor xml:id="_a11318_source_1l00027"/>00027 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Use&#32;an&#32;initializer&#32;list&#32;to&#32;construct&#32;each&#32;GDT&#32;entry.</emphasis>
<anchor xml:id="_a11318_source_1l00028"/>00028 &#32;&#32;&#32;&#32;:&#32;<link linkend="_a11396_1a4facd1fb9d9bd77b1dd234a062c8d9dd">nullSegment</link>(),&#32;<emphasis role="comment">//&#32;First&#32;entry&#32;must&#32;be&#32;a&#32;null&#32;descriptor.</emphasis>
<anchor xml:id="_a11318_source_1l00029"/>00029 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_a11396_1a42e2af3e7b809f6f5e06ecfecdb504e0">kernel_CS</link>(0,&#32;0xFFFFFFFF,&#32;<link linkend="_a11396_1ac4461ee84aade9ee824de64d4846ec98">GDT_ACCESS_CODE_PL0</link>,&#32;<link linkend="_a11396_1a4941c819dbbef299c391bf53c24caf8d">GDT_GRAN_FLAGS</link>),
<anchor xml:id="_a11318_source_1l00030"/>00030 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_a11396_1a1b73e3464fcb9312774f2347e1b7604e">kernel_DS</link>(0,&#32;0xFFFFFFFF,&#32;<link linkend="_a11396_1a1adfff1c72212b5c4e1df35485bb102a">GDT_ACCESS_DATA_PL0</link>,&#32;<link linkend="_a11396_1a4941c819dbbef299c391bf53c24caf8d">GDT_GRAN_FLAGS</link>),
<anchor xml:id="_a11318_source_1l00031"/>00031 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_a11396_1a8d89c16e869ec13a725c780925713916">user_CS</link>(0,&#32;0xFFFFFFFF,&#32;<link linkend="_a11396_1a01d908c8637340b21274e0176b320c05">GDT_ACCESS_CODE_PL3</link>,&#32;<link linkend="_a11396_1a4941c819dbbef299c391bf53c24caf8d">GDT_GRAN_FLAGS</link>),
<anchor xml:id="_a11318_source_1l00032"/>00032 &#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_a11396_1a137b4628cf352225e57720432f2db487">user_DS</link>(0,&#32;0xFFFFFFFF,&#32;<link linkend="_a11396_1ac7f57dcdd84028460100b6da75ad4938">GDT_ACCESS_DATA_PL3</link>,&#32;<link linkend="_a11396_1a4941c819dbbef299c391bf53c24caf8d">GDT_GRAN_FLAGS</link>)
<anchor xml:id="_a11318_source_1l00033"/>00033 {
<anchor xml:id="_a11318_source_1l00034"/>00034 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;GDT&#32;limit&#32;is&#32;its&#32;total&#32;size&#32;in&#32;bytes&#32;minus&#32;1.</emphasis>
<anchor xml:id="_a11318_source_1l00035"/>00035 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;5&#32;entries&#32;*&#32;8&#32;bytes/entry&#32;=&#32;40&#32;bytes.&#32;Limit&#32;=&#32;39&#32;(0x27).</emphasis>
<anchor xml:id="_a11318_source_1l00036"/>00036 &#32;&#32;&#32;&#32;<link linkend="_a12306_1a4105a25a1ec71dc7e338639bb370c664">limit</link>&#32;=&#32;(<emphasis role="keyword">sizeof</emphasis>(<link linkend="_a12302">essential::GDT_row</link>)&#32;*&#32;5)&#32;-&#32;1;
<anchor xml:id="_a11318_source_1l00037"/>00037 &#32;&#32;&#32;&#32;
<anchor xml:id="_a11318_source_1l00038"/>00038 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;The&#32;base&#32;address&#32;is&#32;the&#32;address&#32;of&#32;the&#32;first&#32;entry&#32;in&#32;our&#32;table.</emphasis>
<anchor xml:id="_a11318_source_1l00039"/>00039 &#32;&#32;&#32;&#32;<link linkend="_a12306_1ad0a48a89930e6a6c4467c977f4e91269">base</link>&#32;=&#32;(uintptr_t)&amp;this-&gt;<link linkend="_a12306_1a154c2e2725809d873c8e7d5f19ea66c5">nullSegment</link>;
<anchor xml:id="_a11318_source_1l00040"/>00040 }
<anchor xml:id="_a11318_source_1l00041"/>00041 
<anchor xml:id="_a11318_source_1l00042"/><link linkend="_a12306_1a9b61f75de7fa2ffe9589f43c3f6a6a6c">00042</link> <link linkend="_a12306_1a9b61f75de7fa2ffe9589f43c3f6a6a6c">essential::GDT::~GDT</link>()&#32;{}
<anchor xml:id="_a11318_source_1l00043"/>00043 
<anchor xml:id="_a11318_source_1l00044"/>00044 
<anchor xml:id="_a11318_source_1l00045"/>00045 <emphasis role="comment">//&#32;Loads&#32;this&#32;GDT&#32;into&#32;the&#32;CPU&apos;s&#32;GDTR&#32;and&#32;reloads&#32;segment&#32;registers.</emphasis>
<anchor xml:id="_a11318_source_1l00046"/><link linkend="_a12306_1af8e3c1da270077eb7cc6551b35c0e5ca">00046</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_a12306_1af8e3c1da270077eb7cc6551b35c0e5ca">essential::GDT::installTable</link>()&#32;{
<anchor xml:id="_a11318_source_1l00047"/>00047 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;A&#32;structure&#32;that&#32;matches&#32;the&#32;6-byte&#32;format&#32;required&#32;by&#32;the&#32;&apos;lgdt&apos;&#32;instruction.</emphasis>
<anchor xml:id="_a11318_source_1l00048"/>00048 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>GDT_Pointer&#32;{
<anchor xml:id="_a11318_source_1l00049"/>00049 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;uint16_t&#32;<link linkend="_a11396_1ab28e82ae69032cb4ad3ec3a0be3d7129">limit</link>;
<anchor xml:id="_a11318_source_1l00050"/>00050 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;uint32_t&#32;<link linkend="_a11396_1ad516e6ff5b7dd7f6ce2946c527ddb8b9">base</link>;&#32;<emphasis role="comment">//&#32;Use&#32;uint32_t&#32;for&#32;our&#32;i686&#32;(32-bit)&#32;target</emphasis>
<anchor xml:id="_a11318_source_1l00051"/>00051 &#32;&#32;&#32;&#32;}&#32;<link linkend="_a11369_1a4bbf25084dee10ec29f4356cacced463">__attribute__</link>((packed));
<anchor xml:id="_a11318_source_1l00052"/>00052 
<anchor xml:id="_a11318_source_1l00053"/>00053 &#32;&#32;&#32;&#32;GDT_Pointer&#32;gdt_ptr;
<anchor xml:id="_a11318_source_1l00054"/>00054 &#32;&#32;&#32;&#32;gdt_ptr.limit&#32;=&#32;this-&gt;<link linkend="_a11396_1ab28e82ae69032cb4ad3ec3a0be3d7129">limit</link>;
<anchor xml:id="_a11318_source_1l00055"/>00055 &#32;&#32;&#32;&#32;gdt_ptr.base&#32;=&#32;this-&gt;<link linkend="_a11396_1ad516e6ff5b7dd7f6ce2946c527ddb8b9">base</link>;
<anchor xml:id="_a11318_source_1l00056"/>00056 &#32;&#32;&#32;&#32;
<anchor xml:id="_a11318_source_1l00057"/>00057 &#32;&#32;&#32;&#32;<emphasis role="keyword">asm</emphasis>&#32;<emphasis role="keyword">volatile</emphasis>(
<anchor xml:id="_a11318_source_1l00058"/>00058 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Load&#32;the&#32;address&#32;of&#32;our&#32;GDT_Pointer&#32;structure&#32;into&#32;the&#32;GDTR.</emphasis>
<anchor xml:id="_a11318_source_1l00059"/>00059 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;lgdt&#32;(%0)\n\t&quot;</emphasis>
<anchor xml:id="_a11318_source_1l00060"/>00060 
<anchor xml:id="_a11318_source_1l00061"/>00061 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Reload&#32;all&#32;data&#32;segment&#32;registers&#32;with&#32;the&#32;kernel&#32;data&#32;selector.</emphasis>
<anchor xml:id="_a11318_source_1l00062"/>00062 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;mov&#32;$0x10,&#32;%%ax\n\t&quot;</emphasis>&#32;&#32;&#32;<emphasis role="comment">//&#32;0x10&#32;is&#32;the&#32;selector&#32;for&#32;kernel_DS</emphasis>
<anchor xml:id="_a11318_source_1l00063"/>00063 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;mov&#32;%%ax,&#32;%%ds\n\t&quot;</emphasis>
<anchor xml:id="_a11318_source_1l00064"/>00064 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;mov&#32;%%ax,&#32;%%es\n\t&quot;</emphasis>
<anchor xml:id="_a11318_source_1l00065"/>00065 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;mov&#32;%%ax,&#32;%%fs\n\t&quot;</emphasis>
<anchor xml:id="_a11318_source_1l00066"/>00066 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;mov&#32;%%ax,&#32;%%gs\n\t&quot;</emphasis>
<anchor xml:id="_a11318_source_1l00067"/>00067 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;mov&#32;%%ax,&#32;%%ss\n\t&quot;</emphasis>
<anchor xml:id="_a11318_source_1l00068"/>00068 
<anchor xml:id="_a11318_source_1l00069"/>00069 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Perform&#32;a&#32;32-bit&#32;far&#32;jump&#32;to&#32;reload&#32;the&#32;CS&#32;register&#32;and&#32;flush&#32;the&#32;CPU&#32;pipeline.</emphasis>
<anchor xml:id="_a11318_source_1l00070"/>00070 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;jmp&#32;$0x08,&#32;$flush_cs\n\t&quot;</emphasis>&#32;<emphasis role="comment">//&#32;0x08&#32;is&#32;the&#32;selector&#32;for&#32;kernel_CS</emphasis>
<anchor xml:id="_a11318_source_1l00071"/>00071 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="stringliteral">&quot;flush_cs:\n\t&quot;</emphasis>
<anchor xml:id="_a11318_source_1l00072"/>00072 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;:&#32;<emphasis role="comment">//&#32;No&#32;output&#32;operands</emphasis>
<anchor xml:id="_a11318_source_1l00073"/>00073 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;:&#32;<emphasis role="stringliteral">&quot;r&quot;</emphasis>(&amp;gdt_ptr)&#32;<emphasis role="comment">//&#32;Input:&#32;address&#32;of&#32;our&#32;GDT_Pointer</emphasis>
<anchor xml:id="_a11318_source_1l00074"/>00074 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;:&#32;<emphasis role="stringliteral">&quot;memory&quot;</emphasis>,&#32;<emphasis role="stringliteral">&quot;eax&quot;</emphasis>&#32;<emphasis role="comment">//&#32;Clobbered&#32;registers</emphasis>
<anchor xml:id="_a11318_source_1l00075"/>00075 &#32;&#32;&#32;&#32;);
<anchor xml:id="_a11318_source_1l00076"/>00076 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;GDT&#32;Installed\n&quot;</emphasis>);
<anchor xml:id="_a11318_source_1l00077"/>00077 }
<anchor xml:id="_a11318_source_1l00078"/>00078 
<anchor xml:id="_a11318_source_1l00082"/><link linkend="_a12306_1a9c89bddfdb21d5cc09c1d82411982de9">00082</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_a12306_1a9c89bddfdb21d5cc09c1d82411982de9">essential::GDT::printLoadedTable</link>()&#32;{
<anchor xml:id="_a11318_source_1l00083"/>00083 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>GDT_Pointer&#32;{
<anchor xml:id="_a11318_source_1l00084"/>00084 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;uint16_t&#32;<link linkend="_a11396_1ab28e82ae69032cb4ad3ec3a0be3d7129">limit</link>;
<anchor xml:id="_a11318_source_1l00085"/>00085 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;uint32_t&#32;<link linkend="_a11396_1ad516e6ff5b7dd7f6ce2946c527ddb8b9">base</link>;
<anchor xml:id="_a11318_source_1l00086"/>00086 &#32;&#32;&#32;&#32;}&#32;<link linkend="_a11369_1a4bbf25084dee10ec29f4356cacced463">__attribute__</link>((packed));
<anchor xml:id="_a11318_source_1l00087"/>00087 
<anchor xml:id="_a11318_source_1l00088"/>00088 &#32;&#32;&#32;&#32;GDT_Pointer&#32;gdtr;
<anchor xml:id="_a11318_source_1l00089"/>00089 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Store&#32;the&#32;current&#32;GDT&#32;register&#32;contents&#32;into&#32;our&#32;struct.</emphasis>
<anchor xml:id="_a11318_source_1l00090"/>00090 &#32;&#32;&#32;&#32;<emphasis role="keyword">asm</emphasis>&#32;<emphasis role="keyword">volatile</emphasis>(<emphasis role="stringliteral">&quot;sgdt&#32;%0&quot;</emphasis>&#32;:&#32;<emphasis role="stringliteral">&quot;=m&quot;</emphasis>(gdtr));
<anchor xml:id="_a11318_source_1l00091"/>00091 
<anchor xml:id="_a11318_source_1l00092"/>00092 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;---\n&quot;</emphasis>);
<anchor xml:id="_a11318_source_1l00093"/>00093 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;INFO&#32;about&#32;:&#32;Currently&#32;Loaded&#32;GDT\n&quot;</emphasis>);
<anchor xml:id="_a11318_source_1l00094"/>00094 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;Base&#32;Address:&#32;%#x\n&quot;</emphasis>,&#32;gdtr.base);
<anchor xml:id="_a11318_source_1l00095"/>00095 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;Limit:&#32;%#x&#32;(%d&#32;bytes)\n&quot;</emphasis>,&#32;gdtr.limit,&#32;gdtr.limit);
<anchor xml:id="_a11318_source_1l00096"/>00096 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;Entries:&#32;%d\n&quot;</emphasis>,&#32;(gdtr.limit&#32;+&#32;1)&#32;/&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_a12302">essential::GDT_row</link>));
<anchor xml:id="_a11318_source_1l00097"/>00097 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;---\n&quot;</emphasis>);
<anchor xml:id="_a11318_source_1l00098"/>00098 
<anchor xml:id="_a11318_source_1l00099"/>00099 &#32;&#32;&#32;&#32;<link linkend="_a12302">essential::GDT_row</link>*&#32;gdt_entries&#32;=&#32;(<link linkend="_a12302">essential::GDT_row</link>*)gdtr.base;
<anchor xml:id="_a11318_source_1l00100"/>00100 &#32;&#32;&#32;&#32;<emphasis role="keywordtype">int</emphasis>&#32;num_entries&#32;=&#32;(gdtr.limit&#32;+&#32;1)&#32;/&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_a12302">essential::GDT_row</link>);
<anchor xml:id="_a11318_source_1l00101"/>00101 
<anchor xml:id="_a11318_source_1l00102"/>00102 &#32;&#32;&#32;&#32;<emphasis role="keywordflow">for</emphasis>&#32;(<emphasis role="keywordtype">int</emphasis>&#32;i&#32;=&#32;0;&#32;i&#32;&lt;&#32;num_entries;&#32;i++)&#32;{
<anchor xml:id="_a11318_source_1l00103"/>00103 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_a12302">essential::GDT_row</link>&#32;entry&#32;=&#32;gdt_entries[i];
<anchor xml:id="_a11318_source_1l00104"/>00104 
<anchor xml:id="_a11318_source_1l00105"/>00105 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Reconstruct&#32;the&#32;base&#32;and&#32;limit&#32;from&#32;the&#32;scattered&#32;fields.</emphasis>
<anchor xml:id="_a11318_source_1l00106"/>00106 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;uint32_t&#32;<link linkend="_a11396_1ad516e6ff5b7dd7f6ce2946c527ddb8b9">base</link>&#32;=&#32;entry.<link linkend="_a12302_1a2cbd86d4258ecebf7b46cc9bb8611b5b">base_high</link>&#32;&lt;&lt;&#32;24&#32;|&#32;entry.<link linkend="_a12302_1a8429e04bddc6a61c4e95b88901ae219d">base_middle</link>&#32;&lt;&lt;&#32;16&#32;|&#32;entry.<link linkend="_a12302_1a298d18522898ad48c1e05b79f1f4dff7">base_low</link>;
<anchor xml:id="_a11318_source_1l00107"/>00107 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;uint32_t&#32;<link linkend="_a11396_1ab28e82ae69032cb4ad3ec3a0be3d7129">limit</link>&#32;=&#32;(entry.<link linkend="_a12302_1af180a640dbd5213b3f936ff7cf48deaf">granularity</link>&#32;&amp;&#32;0x0F)&#32;&lt;&lt;&#32;16&#32;|&#32;entry.<link linkend="_a12302_1a2bddbe405dfbbbd101c475bd1bd65112">limit_low</link>;
<anchor xml:id="_a11318_source_1l00108"/>00108 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;
<anchor xml:id="_a11318_source_1l00109"/>00109 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;If&#32;the&#32;granularity&#32;bit&#32;is&#32;set,&#32;the&#32;limit&#32;is&#32;in&#32;4&#32;KiB&#32;pages.</emphasis>
<anchor xml:id="_a11318_source_1l00110"/>00110 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<emphasis role="keywordflow">if</emphasis>&#32;((entry.<link linkend="_a12302_1af180a640dbd5213b3f936ff7cf48deaf">granularity</link>&#32;&amp;&#32;0x80)&#32;!=&#32;0)&#32;{
<anchor xml:id="_a11318_source_1l00111"/>00111 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_a11396_1ab28e82ae69032cb4ad3ec3a0be3d7129">limit</link>&#32;=&#32;(<link linkend="_a11396_1ab28e82ae69032cb4ad3ec3a0be3d7129">limit</link>&#32;&lt;&lt;&#32;12)&#32;|&#32;0xFFF;
<anchor xml:id="_a11318_source_1l00112"/>00112 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;}
<anchor xml:id="_a11318_source_1l00113"/>00113 
<anchor xml:id="_a11318_source_1l00114"/>00114 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;GDT&#32;Entry&#32;%d:&#32;Base=%p,&#32;Limit=%#x,&#32;Access=%#x,&#32;Granularity=%#x\n&quot;</emphasis>,
<anchor xml:id="_a11318_source_1l00115"/>00115 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;i,&#32;(<emphasis role="keywordtype">void</emphasis>*)(uintptr_t)<link linkend="_a11396_1ad516e6ff5b7dd7f6ce2946c527ddb8b9">base</link>,&#32;<link linkend="_a11396_1ab28e82ae69032cb4ad3ec3a0be3d7129">limit</link>,&#32;entry.<link linkend="_a12302_1a7f01a0febd325787f1ff47d6a3b668a9">access</link>,&#32;entry.<link linkend="_a12302_1af180a640dbd5213b3f936ff7cf48deaf">granularity</link>);
<anchor xml:id="_a11318_source_1l00116"/>00116 &#32;&#32;&#32;&#32;}
<anchor xml:id="_a11318_source_1l00117"/>00117 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;---\n&quot;</emphasis>);
<anchor xml:id="_a11318_source_1l00118"/>00118 }
<anchor xml:id="_a11318_source_1l00119"/>00119 
<anchor xml:id="_a11318_source_1l00120"/><link linkend="_a12306_1a2ae998750fc1e18e6778e92774bd3574">00120</link> <emphasis role="keywordtype">void</emphasis>&#32;<link linkend="_a12306_1a2ae998750fc1e18e6778e92774bd3574">essential::GDT::printLoadedTableHeader</link>()&#32;{
<anchor xml:id="_a11318_source_1l00121"/>00121 &#32;&#32;&#32;&#32;<emphasis role="keyword">struct&#32;</emphasis>GDT_Pointer&#32;{
<anchor xml:id="_a11318_source_1l00122"/>00122 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;uint16_t&#32;<link linkend="_a11396_1ab28e82ae69032cb4ad3ec3a0be3d7129">limit</link>;
<anchor xml:id="_a11318_source_1l00123"/>00123 &#32;&#32;&#32;&#32;&#32;&#32;&#32;&#32;uint32_t&#32;<link linkend="_a11396_1ad516e6ff5b7dd7f6ce2946c527ddb8b9">base</link>;
<anchor xml:id="_a11318_source_1l00124"/>00124 &#32;&#32;&#32;&#32;}&#32;<link linkend="_a11369_1a4bbf25084dee10ec29f4356cacced463">__attribute__</link>((packed));
<anchor xml:id="_a11318_source_1l00125"/>00125 
<anchor xml:id="_a11318_source_1l00126"/>00126 &#32;&#32;&#32;&#32;GDT_Pointer&#32;gdtr;
<anchor xml:id="_a11318_source_1l00127"/>00127 &#32;&#32;&#32;&#32;<emphasis role="comment">//&#32;Store&#32;the&#32;current&#32;GDT&#32;register&#32;contents&#32;into&#32;our&#32;struct.</emphasis>
<anchor xml:id="_a11318_source_1l00128"/>00128 &#32;&#32;&#32;&#32;<emphasis role="keyword">asm</emphasis>&#32;<emphasis role="keyword">volatile</emphasis>(<emphasis role="stringliteral">&quot;sgdt&#32;%0&quot;</emphasis>&#32;:&#32;<emphasis role="stringliteral">&quot;=m&quot;</emphasis>(gdtr));
<anchor xml:id="_a11318_source_1l00129"/>00129 
<anchor xml:id="_a11318_source_1l00130"/>00130 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;---\n&quot;</emphasis>);
<anchor xml:id="_a11318_source_1l00131"/>00131 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;INFO&#32;about&#32;:&#32;Currently&#32;Loaded&#32;GDT\n&quot;</emphasis>);
<anchor xml:id="_a11318_source_1l00132"/>00132 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;Base&#32;Address:&#32;%#x\n&quot;</emphasis>,&#32;gdtr.base);
<anchor xml:id="_a11318_source_1l00133"/>00133 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;Limit:&#32;%#x&#32;(%d&#32;bytes)\n&quot;</emphasis>,&#32;gdtr.limit,&#32;gdtr.limit);
<anchor xml:id="_a11318_source_1l00134"/>00134 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;Entries:&#32;%d\n&quot;</emphasis>,&#32;(gdtr.limit&#32;+&#32;1)&#32;/&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_a12302">essential::GDT_row</link>));
<anchor xml:id="_a11318_source_1l00135"/>00135 &#32;&#32;&#32;&#32;<link linkend="_a11403_1a45ee52b918a784ff0e96e7c8917a91d9">basic::printf</link>(<emphasis role="stringliteral">&quot;---\n&quot;</emphasis>);
<anchor xml:id="_a11318_source_1l00136"/>00136 }
<anchor xml:id="_a11318_source_1l00137"/>00137 
<anchor xml:id="_a11318_source_1l00138"/>00138 <emphasis role="comment">//&#32;---&#32;Static&#32;functions&#32;to&#32;get&#32;segment&#32;selectors&#32;---</emphasis>
<anchor xml:id="_a11318_source_1l00139"/>00139 
<anchor xml:id="_a11318_source_1l00140"/><link linkend="_a12306_1a89a8d2c17e3c22e7200bff09252f46e1">00140</link> uint16_t&#32;<link linkend="_a12306_1a89a8d2c17e3c22e7200bff09252f46e1">essential::GDT::kernel_CS_selector</link>()&#32;{&#32;<emphasis role="keywordflow">return</emphasis>&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_a12302">essential::GDT_row</link>)&#32;*&#32;1;&#32;}&#32;<emphasis role="comment">//&#32;Selector&#32;0x08</emphasis>
<anchor xml:id="_a11318_source_1l00141"/><link linkend="_a12306_1a34661a528b1630bff806e25411ad6ec3">00141</link> uint16_t&#32;<link linkend="_a12306_1a34661a528b1630bff806e25411ad6ec3">essential::GDT::kernel_DS_selector</link>()&#32;{&#32;<emphasis role="keywordflow">return</emphasis>&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_a12302">essential::GDT_row</link>)&#32;*&#32;2;&#32;}&#32;<emphasis role="comment">//&#32;Selector&#32;0x10</emphasis>
<anchor xml:id="_a11318_source_1l00142"/><link linkend="_a12306_1a8806a14009c4f0432d4b7043d687be17">00142</link> uint16_t&#32;<link linkend="_a12306_1a8806a14009c4f0432d4b7043d687be17">essential::GDT::user_CS_selector</link>()&#32;&#32;&#32;{&#32;<emphasis role="keywordflow">return</emphasis>&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_a12302">essential::GDT_row</link>)&#32;*&#32;3;&#32;}&#32;<emphasis role="comment">//&#32;Selector&#32;0x18</emphasis>
<anchor xml:id="_a11318_source_1l00143"/><link linkend="_a12306_1a90661f97e9cf214dd6d977b19c01f7fc">00143</link> uint16_t&#32;<link linkend="_a12306_1a90661f97e9cf214dd6d977b19c01f7fc">essential::GDT::user_DS_selector</link>()&#32;&#32;&#32;{&#32;<emphasis role="keywordflow">return</emphasis>&#32;<emphasis role="keyword">sizeof</emphasis>(<link linkend="_a12302">essential::GDT_row</link>)&#32;*&#32;4;&#32;}&#32;<emphasis role="comment">//&#32;Selector&#32;0x20</emphasis>
</programlisting></section>
